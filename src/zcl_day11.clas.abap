CLASS zcl_day11 DEFINITION PUBLIC FINAL CREATE PUBLIC.
  PUBLIC SECTION.
    CLASS-METHODS part1 IMPORTING use_sample    TYPE abap_bool OPTIONAL
                        RETURNING VALUE(result) TYPE int8.

    CLASS-METHODS part2 IMPORTING use_sample    TYPE abap_bool OPTIONAL
                        RETURNING VALUE(result) TYPE int8.

    INTERFACES if_oo_adt_classrun.

  PRIVATE SECTION.
    CLASS-METHODS get_puzzle_sample RETURNING VALUE(result) TYPE string.
    CLASS-METHODS get_puzzle_input  RETURNING VALUE(result) TYPE string.
ENDCLASS.


CLASS zcl_day11 IMPLEMENTATION.
  METHOD if_oo_adt_classrun~main.
    DATA(result1) = zcl_day11=>part1( ).
    out->write( name = |The sum of these lengths:|
                data = result1 ). " Answer: 9177603

    DATA(result2) = zcl_day11=>part2( ).
    out->write( name = |The sum of these older lengths:|
                data = result2 ). " Answer: 632003913611
  ENDMETHOD.

  METHOD part1.
    DATA(input) = COND string( WHEN use_sample = abap_true THEN get_puzzle_sample( ) ELSE get_puzzle_input( ) ).
    DATA(width) = COND i( WHEN use_sample = abap_true THEN 10 ELSE 140 ).
    DATA(offset) = 0.
    DO.
      IF input+offset(1) = '.'.
        offset = offset + 1.
        IF offset MOD width = 0.
          input = insert( val = input
                          sub = repeat( val = '.'
                                        occ = width )
                          off = offset ).
          offset = offset + width.
        ENDIF.
      ELSE.
        offset = offset + width - offset MOD width.
      ENDIF.
      IF offset >= strlen( input ).
        EXIT.
      ENDIF.
    ENDDO.
    offset = 0.
    DO.
      IF input+offset(1) = '.'.
        offset = offset + width.
        IF offset > strlen( input ).
          offset = offset MOD width + 1.
          width = width + 1.
          input = REDUCE string(
            INIT temp = input
            FOR i = 0 WHILE i <= strlen( input ) / width
            NEXT temp = insert( val = temp
                                sub = '.'
                                off = i * width + offset ) ).
          offset = offset + 1.
          IF offset >= width.
            EXIT.
          ENDIF.
        ENDIF.
      ELSE.
        offset = offset MOD width + 1.
        IF offset >= width.
          EXIT.
        ENDIF.
      ENDIF.
    ENDDO.
    offset = -1.
    DATA galaxies TYPE TABLE OF i WITH EMPTY KEY.
    DO.
      offset = find( val = input
                     sub = '#'
                     off = offset + 1 ).
      IF offset > -1.
        INSERT offset INTO TABLE galaxies.
      ELSE.
        EXIT.
      ENDIF.
    ENDDO.
    result = REDUCE i(
      INIT sum = 0
      FOR <galaxy1> IN galaxies INDEX INTO galaxy_index
      FOR <galaxy2> IN galaxies FROM galaxy_index + 1
      NEXT sum = sum + abs( <galaxy1> MOD width - <galaxy2> MOD width ) + abs( <galaxy1> DIV width - <galaxy2> DIV width ) ).
  ENDMETHOD.

  METHOD part2.
    DATA(input) = COND string( WHEN use_sample = abap_true THEN get_puzzle_sample( ) ELSE get_puzzle_input( ) ).
    DATA(width) = COND i( WHEN use_sample = abap_true THEN 10 ELSE 140 ).
    DATA(offset) = 0.

    DATA empty_rows TYPE TABLE OF i WITH EMPTY KEY.
    DO.
      IF input+offset(1) = '.'.
        offset = offset + 1.
        IF offset MOD width = 0.
          INSERT offset DIV width - 1 INTO TABLE empty_rows.
          offset = offset + width.
        ENDIF.
      ELSE.
        offset = offset + width - offset MOD width.
      ENDIF.
      IF offset >= strlen( input ).
        EXIT.
      ENDIF.
    ENDDO.
    offset = 0.
    DATA empty_cols TYPE TABLE OF i WITH EMPTY KEY.
    DO.
      IF input+offset(1) = '.'.
        offset = offset + width.
        IF offset >= strlen( input ).
          INSERT offset MOD width INTO TABLE empty_cols.
          offset = offset MOD width + 1.
          IF offset >= width.
            EXIT.
          ENDIF.
        ENDIF.
      ELSE.
        offset = offset MOD width + 1.
        IF offset >= width.
          EXIT.
        ENDIF.
      ENDIF.
    ENDDO.
    offset = -1.
    DATA galaxies TYPE TABLE OF i WITH EMPTY KEY.
    DO.
      offset = find( val = input
                     sub = '#'
                     off = offset + 1 ).
      IF offset > -1.
        INSERT offset INTO TABLE galaxies.
      ELSE.
        EXIT.
      ENDIF.
    ENDDO.

    result = REDUCE int8(
      INIT sum TYPE int8
      FOR <galaxy1> IN galaxies INDEX INTO galaxy_index
      FOR <galaxy2> IN galaxies FROM galaxy_index + 1
      NEXT sum = sum +
        REDUCE int8(
          INIT sum_col TYPE int8
          FOR col = nmin( val1 = <galaxy1> MOD width
                          val2 = <galaxy2> MOD width )
          WHILE col < nmax( val1 = <galaxy1> MOD width
                            val2 = <galaxy2> MOD width )
          NEXT sum_col = sum_col + COND int8( WHEN line_exists( empty_cols[ table_line = col ] ) THEN 1000000 ELSE 1 ) ) +
        REDUCE int8(
          INIT sum_row TYPE int8
          FOR row = nmin( val1 = <galaxy1> DIV width
                          val2 = <galaxy2> DIV width )
          WHILE row < nmax( val1 = <galaxy1> DIV width
                            val2 = <galaxy2> DIV width )
          NEXT sum_row = sum_row + COND int8( WHEN line_exists( empty_rows[ table_line = row ] ) THEN 1000000 ELSE 1 ) ) +
        0 ).
  ENDMETHOD.

  METHOD get_puzzle_sample.
    result =
|...#......| &&
|.......#..| &&
|#.........| &&
|..........| &&
|......#...| &&
|.#........| &&
|.........#| &&
|..........| &&
|.......#..| &&
|#...#.....|.
  ENDMETHOD.

  METHOD get_puzzle_input.
    result =
|....................................#..............#.................................#......................................................| &&
|............#......#..........................................................#.....................................#.................#.....| &&
|.........................................................................................#...................#..............................| &&
|.....#......................................................#...............................................................................| &&
|..........................................................................#........................#.............................#..........| &&
|......................#.................#...............................................................................#...................| &&
|........#......................................................#...............................#............................................| &&
|...........................#.................#.......................................#...................#.........#.................#......| &&
|.#................#.......................................#..........#........#.............................................................| &&
|............................................................................................................................................| &&
|..................................#.........................................................................................................| &&
|.........................................................................................#.................................#................| &&
|.......#.............#................................#........#.....................................#......................................| &&
|..........................................#.................................................................................................| &&
|.............#...............................................................................................#..........#...................| &&
|....................................#.................................#............#....................#......................#............| &&
|............................................................................................#...............................................| &&
|........#...........................................#.......#.............................................................................#.| &&
|.....................#.......#..................................................#....................................................#......| &&
|..............#........................#.......#........................#................................................#..................| &&
|.......................................................#..........................................................#.........................| &&
|..#..............................................................#..........#.......................#.......................................| &&
|..................................................#......................................................#..................................| &&
|......................................................................................................................#.....................| &&
|.....#................................#...............................................#.....................................................| &&
|...................#.....#...............................#.......................#..............#..........................#................| &&
|.........#.................................#................................................................................................| &&
|..................................................................#.................................#......#.......................#........| &&
|............................#........................................................................................#..................#...| &&
|.................#...............................#............#............#................................................................| &&
|................................#................................................................#..........................................| &&
|............................................#.........................................#.......................................#.............| &&
|.........#.................................................................................#............................#............#......| &&
|..#....................................................#..........#.............#.........................#.................................| &&
|...........................#...................#............................................................................................| &&
|...................................#...................................#..........................................................#.........| &&
|................#..................................................................#..................#..........#..........................| &&
|.............................................................#...............................#..............................................| &&
|#.................................................................................................#.......................#.................| &&
|.........................#...............#..................................................................................................| &&
|...........................................................................................................#..................#......#......| &&
|.........................................................#.................................................................................#| &&
|..............................#.............#......#....................................................................#...................| &&
|.....#......................................................................#...............................................................| &&
|...............................................................................................................#.......................#....| &&
|............#.........#................#...............#............#...........#...........#........................#......................| &&
|............................................................................................................................................| &&
|................#.................................#............#..........................................................#........#........| &&
|...............................#...............................................................#...........................................#| &&
|.........................................#.............................#.............................#......................................| &&
|...................................................................................#.......................#................................| &&
|.........#................#...................#.........................................#...............................#...............#...| &&
|....................#................#......................................#.....................#.............#...........................| &&
|............................................................................................................................................| &&
|......................................................................#.....................................................................| &&
|......#..........................................................#........................................................................#.| &&
|.............#.........................#.......................................#............................#.....#......#..................| &&
|.........................#........#.........#......#.................................#.....#................................................| &&
|..#.....................................................#.........................................#.........................................| &&
|....................#...............................................#.......................................................................| &&
|........................................................................................................#.......................#.......#...| &&
|.............................#...................................................#.........................................#................| &&
|....................................................................................................#.......................................| &&
|.......#..........#..............................................#........#.................#..................#............................| &&
|....................................#..........#......#.....#.........................................................#.............#.......| &&
|............................................................................................................................................| &&
|..............................#................................................................#..........#.................................| &&
|..#..............................................................................................................................#..........| &&
|..............................................................................................................#.............................| &&
|.................................................#........................#...............................................#.................| &&
|...................#.....................................................................................................................#..| &&
|......#....................#......#.....#................#...................................#.............#................................| &&
|.............................................#.......................................#...............................#......................| &&
|.................................................................................................#..........................................| &&
|...#.................................................................#...........#..........................................................| &&
|....................#..............................................................................................................#........| &&
|..........#.....................#...........................................................#.............#...............................#.| &&
|............................................................................................................................................| &&
|..................................................#............................................................#...........#................| &&
|...........................................#........................#.........#.....................#.......................................| &&
|.#.........................#..............................#.................................................................................| &&
|.....................................................................................#.........................................#............| &&
|..............................................................................................#......................#...................#..| &&
|.....#...........#.....#.....................#..............................................................#...............................| &&
|..........#....................................................#.....#......................................................................| &&
|#...............................#.....#.....................................................................................................| &&
|........................................................#.........................#...................#........#..................#.........| &&
|.............................................................................................................................#.............#| &&
|.........................................................................#.................................#................................| &&
|.........#.......#................................#..............................................#.....................................#....| &&
|............................................................................................................................................| &&
|................................#............#........................#.........................................#...........................| &&
|............#...............................................#........................#................#...............#.....................| &&
|..#....................#..........................................#..........................................................#..............| &&
|...................................................#......................................................................................#.| &&
|................#....................................................................................................................#......| &&
|.......#..................................................#...................#.............#..............#................................| &&
|.................................................................................................................................#..........| &&
|...................#...........#............................................................................................................| &&
|.........................................#.....................#....................................#.........#.......#.....................| &&
|.#........................................................................#..............................#..................................| &&
|............#.....................#.....................................................................................................#...| &&
|.......#....................................................................................................................................| &&
|.................................................................#............#...................#........................#......#.........| &&
|........................................................................................#.......................#...........................| &&
|.........................................#.............................#....................................................................| &&
|..............#......#...............................................................................................................#......| &&
|................................................................................................#......................#....................| &&
|............................#............................#..........................#..................#...................................#| &&
|...........#...............................................................................#....................................#...........| &&
|............................................................................................................................................| &&
|.................#.......#............#.......................................................................#.............................| &&
|............................................................................................................................................| &&
|...#.........................#.................................#...............#............................................#.....#.........| &&
|......................................................#...................#..........#.........#.....#....................................#.| &&
|...................................#.........#......................................................................#.......................| &&
|............................................................................................................................................| &&
|..........#..............#...................................#..............................................................................| &&
|............................................................................................................................................| &&
|.....#...................................................#...............................#...................#..........#..................#| &&
|..............................#.......#........#............................................................................................| &&
|.................#...............................................................#.................................#........................| &&
|.....................................................................#........................................................#.............| &&
|............#..................................................................................#............................................| &&
|.......................#..................................#..............................................................#.............#....| &&
|...................................#........................................................................................................| &&
|...........................................................................#.......................................................#........| &&
|........#....................#.....................#...............#................................#..............#........................| &&
|...#.........#.............................#.........................................#...................#..................................| &&
|..............................................................................#..............#........................................#.....| &&
|..................................#.......................................................................................#.................| &&
|........................#...................................................................................................................| &&
|.......................................................#.............................................#............#.........................| &&
|............................#........#..............................#.......................................................................| &&
|...#........................................................#............#............#............................................#........| &&
|.................#..........................#...............................................................................................| &&
|..........................................................................................#................................................#| &&
|..........#.................................................................................................................................| &&
|.........................#............#........................................................#............................................| &&
|...............#...................................#......................#..............................#...........#......................|.
  ENDMETHOD.
ENDCLASS.
